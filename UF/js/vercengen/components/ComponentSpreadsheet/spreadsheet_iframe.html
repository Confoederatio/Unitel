<!DOCTYPE html>
<!-- METADATA-WALK: ve.Spreadsheet.iframe -->
<html>
<head>
  <script src="../../../../libraries/univer/react.production.min.js"></script>
  <script src="../../../../libraries/univer/react-dom.production.min.js"></script>
  <script src="../../../../libraries/univer/rxjs.umd.min.js"></script>
  <script src="../../../../libraries/univer/echarts.min.js"></script>

  <script src="../../../../libraries/univer/univerjs.index.js"></script>

  <script src="../../../../libraries/univer/univerjs.umd.index.js"></script>
  <script src="../../../../libraries/univer/univer.en-US.js"></script>
  <link rel="stylesheet" href="../../../../libraries/univer/univer.index.css" />
  <style>
      html,
      body,
      #root,
      #app {
          padding: 0;
          margin: 0;
          height: 100%;
          
          font-family: "Karla";
      }
  </style>
</head>
<body>
<div id="app"></div>

<script>
	const { createUniver } = UniverPresets
	const { LocaleType, mergeLocales } = UniverCore
	const { UniverSheetsCorePreset } = UniverPresetSheetsCore
	
	const { univerAPI } = createUniver({
		locale: LocaleType.EN_US,
		locales: {
			[LocaleType.EN_US]: mergeLocales(UniverPresetSheetsCoreEnUS),
		},
		presets: [UniverSheetsCorePreset()],
	})
	
	univerAPI.createWorkbook({ name: 'Test Sheet' });
	univerAPI.addEvent(univerAPI.Event.SheetValueChanged, (e) => {
		window.parent.ve.Spreadsheet.fireToBinding(window.table_id);
	});
	
	//HELPER FUNCTIONS START
	function numberToExcelColumn(n) {
		let column = "";
		
		while (n > 0) {
			n--; // Excel is 1-based
			column = String.fromCharCode(65 + (n % 26)) + column;
			n = Math.floor(n / 26);
		}
		
		return column;
	}
  //HELPER FUNCTIONS END
	
	function coordsToCell (arg0_x, arg1_y) {
		//Convert from parameters
    let x_coord = parseInt(arg0_x);
		let y_coord = parseInt(arg1_y);
		
		//Declare local instance variables
    let column = numberToExcelColumn(x_coord);
		
		//Return statement
    return `${column}${y_coord}`;
  }
	
	function getArrayData () {
		let all_worksheets = univerAPI.getActiveWorkbook().getSheets();
		let data_obj = [];
		
		for (let i = 0; i < all_worksheets.length; i++) {
			let local_data_obj = all_worksheets[i]._worksheet._cellData._matrix;
			
			//Set .data to just be the matrix since it can contain functions as well
			data_obj[i] = [];
			
			//Iterate over all_rows in local_data_obj
      let all_rows = Object.keys(local_data_obj);
			
			for (let x = 0; x < all_rows.length; x++) {
				let local_row = local_data_obj[all_rows[x]];
				let local_row_array = [];
				
				let all_cells = Object.keys(local_row);
				
				for (let y = 0; y < all_cells.length; y++) {
					let local_cell = local_row[all_cells[y]];
					
					//Pad any empty cells until row positions are correct
					if (y === 0 && parseInt(all_cells[y]) > 0)
						for (let z = 0; z < parseInt(all_cells[y]); z++)
							local_row_array.push(undefined);
					
					//Push cell value
					if (local_cell.f !== undefined) {
						local_row_array.push(local_cell.f);
          } else if (local_cell.v !== undefined) {
						local_row_array.push(local_cell.v);
          } else {
						local_row_array.push(undefined);
          }
        }
				
				data_obj[i].push(local_row_array);
      }
		}
		
		//Return statement
		return data_obj;
	}
	
	function getCellData (arg0_sheet_index, arg1_x, arg2_y) {
		//Convert from parameters
    let sheet_index = arg0_sheet_index;
      if (typeof sheet_index === "string")
        sheet_index = getSheetFromName(sheet_index);
		let x_coord = parseInt(arg1_x);
		let y_coord = parseInt(arg2_y);
		
		//Declare local instance variables
    let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		
		if (all_sheets[sheet_index]) {
			let local_data_obj = all_sheets[sheet_index]._worksheet._cellData._matrix;
			
			//Return cell data
      try {
				return local_data_obj[y_coord - 1][x_coord - 1];
      } catch (e) {
				window.parent.console.warn(e);
				return undefined;
      }
    }
  }
  
  function getData () {
		let all_worksheets = univerAPI.getActiveWorkbook().getSheets();
		let data_obj = {};
    
		for (let i = 0; i < all_worksheets.length; i++) {
			let local_data_obj = all_worksheets[i]._worksheet._cellData._matrix;
			
			//Set .data to just be the matrix since it can contain functions as well
			data_obj[all_worksheets[i].getSheetId()] = {
				id: all_worksheets[i].getSheetId(),
        index: i,
				name: all_worksheets[i].getSheetName(),
        
        data: local_data_obj
			}
    }
		
		//Return statement
    return data_obj;
	}
	
	function getSelectedRange () {
		//Declare local instance variables
    let selected_range = univerAPI.getActiveWorkbook()
      .getActiveSheet()
      .getSelection()
      .getActiveRange();
		
		//Return statement
		if (selected_range) {
			selected_range = selected_range._range;
			
			return [
				[getSelectedSheet(), selected_range.startColumn + 1, selected_range.startRow + 1],
				[getSelectedSheet(), selected_range.endColumn + 1, selected_range.endRow + 1]
			];
    }
  }
	
	function getSelectedSheet () {
		//Declare local instance variables
    let active_sheet_obj = univerAPI.getActiveWorkbook().getActiveSheet()._worksheet._snapshot;
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		
		//Iterate over all_sheets and fetch by ID
		for (let i = 0; i < all_sheets.length; i++)
			if (all_sheets[i]._worksheet._sheetId === active_sheet_obj.id)
				//Return statement
				return i;
		return -1;
	}
	
	function getSheetFromName (arg0_sheet_name) {
		//Convert from parameters
    let sheet_name = arg0_sheet_name;
		
		//Iterate over all_sheets
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		
		for (let i = 0; i < all_sheets.length; i++) {
			let local_sheet_data = all_sheets[i]._worksheet._snapshot;
			
			//Return statement
			if (local_sheet_data.name === sheet_name)
				return i;
    }
  }
	
	function getSheetNames () {
		//Declare local instance variables
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		let all_sheet_names = [];
		
		//Iterate over all_sheets
		for (let i = 0; i < all_sheets.length; i++) {
			let local_sheet_data = all_sheets[i]._worksheet._snapshot;
			
			all_sheet_names.push(local_sheet_data.name);
    }
		
		//Return statement
    return all_sheet_names;
  }
	
	function setActiveSheet (arg0_sheet_index) {
		//Convert from parameters
    let sheet_index = arg0_sheet_index;
		
		//Declare local instance variables
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		let all_sheet_ids = [];
    
		//Iterate over all_sheets; populate all_sheet_ids
		for (let i = 0; i < all_sheets.length; i++)
			all_sheet_ids.push(all_sheets[i]._worksheet._sheetId);
		univerAPI.getActiveWorkbook().setActiveSheet(all_sheet_ids[sheet_index]);
  }
	
	function setCellData (arg0_sheet_index, arg1_x, arg2_y, arg2_value) {
		//Convert from parameters
		let sheet_index = arg0_sheet_index;
      if (typeof sheet_index === "string")
        sheet_index = getSheetFromName(sheet_index);
		let x_coord = parseInt(arg1_x);
		let y_coord = parseInt(arg2_y);
    let value = arg2_value;
		  if (typeof value !== "object") value = { v: value };
		
		//Declare local instance variables
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
    
		if (all_sheets[sheet_index]) {
			let local_data_obj = all_sheets[sheet_index]._worksheet._cellData._matrix;
			
			//Set cell data
      try {
				if (!local_data_obj[y_coord - 1]) local_data_obj[y_coord - 1] = {};
				  local_data_obj[y_coord - 1][x_coord - 1] = value;
				
				all_sheets[sheet_index].refreshCanvas();
      } catch (e) {}
    }
  }
	
	function setData (arg0_data_obj) {
		//Convert from parameters
    let data_obj = (arg0_data_obj) ? arg0_data_obj : {};
		
		//Iterate over all_sheet_keys in data_obj
    let all_sheet_keys = Object.keys(data_obj);
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		
		//1. Reset workbook first
		univerAPI.createUniverSheet();
		
		//2. Create any missing sheets
    if (all_sheets.length < all_sheet_keys.length)
			for (let i = all_sheet_keys.length - all_sheets.length; i < all_sheet_keys.length; i++) {
				let local_sheet = data_obj[all_sheet_keys[i]];
				
				univerAPI.getActiveWorkbook().create(local_sheet.name);
      }
		all_sheets = univerAPI.getActiveWorkbook().getSheets();
		
    //3. Populate all sheets with extant data
		for (let i = 0; i < all_sheet_keys.length; i++) {
			let local_sheet = data_obj[all_sheet_keys[i]];
			
			all_sheets[i].setName(local_sheet.name);
			all_sheets[i]._worksheet._cellData._matrix = local_sheet.data;
			all_sheets[i].refreshCanvas();
    }
  }
	
	function setID (arg0_id) {
		//Convert from parameters
    let id = arg0_id;
		
		//Set window.table_id
		window.table_id = id;
  }
	
	function setSelectedRange (arg0_sheet_index, arg1_start_coords, arg2_end_coords) {
		//Convert from parameters
		let sheet_index = arg0_sheet_index;
      if (typeof sheet_index === "string")
        sheet_index = getSheetFromName(sheet_index);
    let start_coords = arg1_start_coords;
		let end_coords = arg2_end_coords;
		
		if (sheet_index === undefined) return; //Internal guard clause if sheet_index is undefined
		
		//Declare local instance variables
		let all_sheets = univerAPI.getActiveWorkbook().getSheets();
		
		if (all_sheets[sheet_index]) {
			let range = all_sheets[sheet_index].getRange(`${coordsToCell(...start_coords)}:${coordsToCell(...end_coords)}`);
			  range.activate();
    }
  }
	
	function toggleDarkMode (arg0_value) {
		univerAPI.toggleDarkMode(arg0_value);
  }
	
</script>
</body>
</html>